<!-- 创建调研记录页面 - Tab页面 -->
<view class="container">
  <!-- 页面标题 -->
  <view class="page-header">
    <view class="page-title">📊 创建调研记录</view>
  </view>

  <!-- 选择任务提示 -->
  <view class="task-banner" wx:if="{{!taskId}}">
    <text class="banner-icon">💡</text>
    <text class="banner-text">请先选择今日调研任务，或从"任务"页面开始</text>
  </view>

  <!-- 当前任务卡片 -->
  <view class="current-task" wx:if="{{taskId}}">
    <view class="task-label">当前任务</view>
    <view class="task-name">{{taskTitle}}</view>
  </view>

  <!-- 店铺信息 -->
  <view class="form-card">
    <view class="form-title">
      <text class="form-icon">🏪</text>
      店铺信息
    </view>

    <!-- 门店选择 -->
    <view class="form-item">
      <view class="form-label">选择门店 <text class="required">*</text></view>
      <picker mode="selector" range="{{storeList}}" value="{{selectedStoreIndex}}" bindchange="onStoreChange">
        <view class="picker {{selectedStoreIndex === -1 ? 'placeholder' : ''}}">
          <text wx:if="{{selectedStoreIndex === -1}}">请选择门店</text>
          <text wx:else>{{storeList[selectedStoreIndex]}}</text>
          <text class="picker-arrow">▼</text>
        </view>
      </picker>
    </view>

    <!-- 竞店选择 -->
    <view class="form-item" wx:if="{{selectedStoreIndex !== -1}}">
      <view class="form-label">选择竞店 <text class="required">*</text></view>
      <picker mode="selector" range="{{competitorList}}" value="{{selectedCompetitorIndex}}" bindchange="onCompetitorChange">
        <view class="picker {{selectedCompetitorIndex === -1 ? 'placeholder' : ''}}">
          <text wx:if="{{selectedCompetitorIndex === -1}}">请选择竞店</text>
          <text wx:else>{{competitorList[selectedCompetitorIndex]}}</text>
          <text class="picker-arrow">▼</text>
        </view>
      </picker>
    </view>

    <view class="form-item">
      <view class="form-label">店铺地址</view>
      <view class="location-row">
        <input 
          class="form-input" 
          placeholder="点击右侧按钮选择店铺位置"
          value="{{form.shopAddress}}"
          data-field="shopAddress"
          bindinput="onInput"
        />
        <view class="location-btn" bindtap="getLocation">
          <text class="location-icon">📍</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 商品选择（从任务列表中选择） -->
  <view class="form-card" wx:if="{{taskItems.length > 0}}">
    <view class="form-title">
      <text class="form-icon">🛒</text>
      选择商品 <text class="required">*</text>
      <text class="progress-text" wx:if="{{totalRecordCount > 0}}">(已调研 {{totalRecordCount}} 次)</text>
    </view>
    
    <view class="items-selector">
      <view 
        class="item-option {{selectedItem && selectedItem.id === item.id ? 'selected' : ''}}" 
        wx:for="{{taskItems}}" 
        wx:key="id"
        bindtap="onSelectItem"
        data-item="{{item}}"
      >
        <view class="item-count {{item.record_count > 0 ? 'has-records' : ''}}">
          {{item.record_count || 0}}
        </view>
        <view class="item-info">
          <text class="item-cat">{{item.category}}</text>
          <text class="item-product">{{item.product_name}}</text>
          <text class="item-spec" wx:if="{{item.product_spec}}">{{item.product_spec}}</text>
        </view>
        <view class="item-check" wx:if="{{selectedItem && selectedItem.id === item.id}}">✓</view>
      </view>
    </view>
  </view>

  <!-- 商品信息表单（可编辑） -->
  <view class="form-card">
    <view class="form-title">
      <text class="form-icon">📦</text>
      商品信息
    </view>
    
    <view class="form-item">
      <view class="form-label">商品名称 <text class="required">*</text></view>
      <input 
        class="form-input" 
        placeholder="请输入商品名称"
        value="{{form.name}}"
        data-field="name"
        bindinput="onNameInput"
        bindfocus="onNameFocus"
        bindblur="onNameBlur"
      />
      <!-- 自动补全下拉列表 -->
      <view class="suggest-list" wx:if="{{suggestList.length > 0 && showSuggest}}">
        <view 
          class="suggest-item" 
          wx:for="{{suggestList}}" 
          wx:key="id"
          bindtap="onSelectSuggest"
          data-item="{{item}}"
        >
          <text class="suggest-cat">{{item.category}}</text>
          <text class="suggest-name">{{item.name}}</text>
          <text class="suggest-spec" wx:if="{{item.spec}}">{{item.spec}}</text>
        </view>
      </view>
    </view>

    <view class="form-row">
      <view class="form-item form-item-half">
        <view class="form-label">品类 <text class="required">*</text></view>
        <input 
          class="form-input" 
          placeholder="如: 蔬菜"
          value="{{form.category}}"
          data-field="category"
          bindinput="onInput"
        />
      </view>

      <view class="form-item form-item-half">
        <view class="form-label">规格</view>
        <input 
          class="form-input" 
          placeholder="如: 500g"
          value="{{form.specification}}"
          data-field="specification"
          bindinput="onInput"
        />
      </view>
    </view>

  </view>

  <!-- 价格信息 -->
  <view class="form-card">
    <view class="form-title">
      <text class="form-icon">💰</text>
      价格信息
    </view>

    <view class="form-row">
      <view class="form-item form-item-half">
        <view class="form-label">价格 <text class="required">*</text></view>
        <input 
          class="form-input price-input" 
          placeholder="0.00"
          type="digit"
          value="{{form.price}}"
          data-field="price"
          bindinput="onInput"
        />
        <text class="price-unit">元</text>
      </view>

      <view class="form-item form-item-half">
        <view class="form-label">促销价</view>
        <input 
          class="form-input price-input" 
          placeholder="0.00"
          type="digit"
          value="{{form.promoPrice}}"
          data-field="promoPrice"
          bindinput="onInput"
        />
        <text class="price-unit">元</text>
      </view>
    </view>

    <view class="form-item">
      <view class="form-label">促销信息</view>
      <input 
        class="form-input" 
        placeholder="如: 买一送一、满减等"
        value="{{form.promoInfo}}"
        data-field="promoInfo"
        bindinput="onInput"
      />
    </view>

    <!-- 拍照上传 -->
    <view class="form-item">
      <view class="form-label">商品照片 <text class="required">*</text></view>
      <view class="photo-section">
        <view class="photo-list">
          <block wx:for="{{photos}}" wx:key="index">
            <view class="photo-item">
              <image 
                class="photo-image" 
                src="{{item}}" 
                mode="aspectFill"
                bindtap="previewPhoto"
                data-index="{{index}}"
              />
              <view class="photo-delete" bindtap="deletePhoto" data-index="{{index}}">
                <text class="delete-icon">×</text>
              </view>
            </view>
          </block>
          <view class="photo-add" bindtap="takePhoto" wx:if="{{photos.length < 3}}">
            <text class="add-icon">📷</text>
            <text class="add-text">拍照</text>
            <text class="add-tip">{{photos.length}}/3</text>
          </view>
        </view>
        <view class="photo-tip">请拍摄商品和价格标签，最多3张</view>
      </view>
    </view>
  </view>

  <!-- 备注 -->
  <view class="form-card">
    <view class="form-title">
      <text class="form-icon">📝</text>
      备注
    </view>
    <textarea 
      class="form-textarea" 
      placeholder="其他补充信息..."
      maxlength="500"
      value="{{form.remark}}"
      data-field="remark"
      bindinput="onInput"
    />
  </view>

  <!-- 提交按钮 -->
  <view class="submit-section">
    <button class="btn-submit" bindtap="saveRecord">保存记录</button>
  </view>

  <!-- 隐藏的 canvas 用于添加水印 -->
  <canvas type="2d" id="watermarkCanvas" style="position: fixed; left: -9999px; top: -9999px; width: 1px; height: 1px;"></canvas>
</view>
