<!-- é¦–é¡µ - ä»»åŠ¡åˆ—è¡¨ -->
<view class="container">
  <!-- æ¬¢è¿å¡ç‰‡ -->
  <view class="welcome-card {{hasTask ? 'has-task' : ''}}">
    <view class="welcome-left">
      <view class="welcome-icon">ğŸ‘‹</view>
      <view class="welcome-text">
        <text class="welcome-name">æ¬¢è¿, {{userInfo.name || 'è°ƒç ”å‘˜'}}</text>
        <text class="welcome-date">{{today}}</text>
      </view>
    </view>
    <view class="welcome-status {{hasTask ? 'has-task' : ''}}">
      {{hasTask ? 'æœ‰ä»»åŠ¡' : 'ä»Šæ—¥ä¼‘æ¯'}}
    </view>
  </view>

  <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
  <view class="stats-grid">
    <view class="stat-item">
      <text class="stat-value">{{stats.today}}</text>
      <text class="stat-label">ä»Šæ—¥ä»»åŠ¡</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{stats.completed}}</text>
      <text class="stat-label">å·²è°ƒç ”å•†å“æ•°</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{stats.pending}}</text>
      <text class="stat-label">å¾…è°ƒç ”å•†å“æ•°</text>
    </view>
  </view>

  <!-- ä»»åŠ¡åˆ—è¡¨ -->
  <view class="task-section">
    <view class="section-header">
      <text class="section-title">ä»Šæ—¥è°ƒç ”ä»»åŠ¡</text>
      <text class="section-action" bindtap="refreshTasks">åˆ·æ–° â†»</text>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:elif="{{!hasTask}}">
      <text class="empty-icon">ğŸ“­</text>
      <text class="empty-title">æš‚æ— ä»Šæ—¥ä»»åŠ¡</text>
      <text class="empty-desc">ä¼‘æ¯ä¸€ä¸‹å§ï¼Œæ˜å¤©ç»§ç»­åŠªåŠ›ï¼</text>
    </view>

    <!-- ä»»åŠ¡å¡ç‰‡åˆ—è¡¨ -->
    <view class="task-list" wx:else>
      <view 
        class="task-card {{item.status === 'cancelled' ? 'cancelled' : ''}}" 
        wx:for="{{tasks}}" 
        wx:key="id"
        bindtap="{{item.status === 'cancelled' ? '' : 'onSelectTask'}}"
        data-task="{{item}}"
      >
        <view class="task-header">
          <text class="task-title">{{item.title}}</text>
          <text class="task-status status-{{item.status}} {{item.status === 'cancelled' ? 'status-cancelled' : ''}}">
            {{item.status === 'active' ? 'è¿›è¡Œä¸­' : (item.status === 'cancelled' ? 'å·²ä½œåºŸ' : 'å·²å®Œæˆ')}}
          </text>
        </view>
        
        <view class="task-info">
          <view class="info-item">
            <text class="info-icon">ğŸ“…</text>
            <text class="info-text">{{item.date}}</text>
          </view>
          <view class="info-item">
            <text class="info-icon">ğŸ“Š</text>
            <text class="info-text">{{item.item_count}}ä¸ªå•†å“</text>
          </view>
        </view>

        <view class="task-desc" wx:if="{{item.description}}">
          {{item.description}}
        </view>

        <!-- å•†å“åˆ—è¡¨ -->
        <view class="items-section" wx:if="{{item.items && item.items.length > 0}}">
          <view class="items-title">
            ğŸ“‹ è°ƒç ”å•†å“ (å·²è°ƒç ” {{item.total_records || 0}} æ¬¡)
            <view class="progress-bar" wx:if="{{item.completion_percent > 0}}">
              <view class="progress-fill" style="width: {{item.completion_percent}}%;"></view>
            </view>
          </view>
          <view class="items-list">
            <view class="item-row {{product.record_count > 0 ? 'completed' : ''}}" wx:for="{{item.items}}" wx:for-item="product" wx:key="id">
              <view class="item-count-badge {{product.record_count > 0 ? 'has-records' : ''}}">
                {{product.record_count || 0}}
              </view>
              <view class="item-category">{{product.category}}</view>
              <view class="item-name">{{product.product_name}}</view>
              <view class="item-spec" wx:if="{{product.product_spec}}">{{product.product_spec}}</view>
            </view>
          </view>
        </view>

        <view class="task-footer">
          <text class="task-time">{{item.created_at}}</text>
          <button 
            class="btn-start" 
            type="primary" 
            size="mini"
            catchtap="onStartSurvey"
            data-task="{{item}}"
            wx:if="{{item.status === 'active'}}"
          >å¼€å§‹è°ƒç ”</button>
        </view>
      </view>
    </view>
  </view>
</view>