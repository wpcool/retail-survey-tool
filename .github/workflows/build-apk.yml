name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: mobile-app
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev cmake libffi-dev libssl-dev automake ccache
        pip install buildozer cython
        
    - name: Setup Android SDK
      run: |
        export ANDROID_HOME=/usr/local/lib/android/sdk
        sudo mkdir -p $ANDROID_HOME && sudo chmod 777 $ANDROID_HOME
        cd /tmp
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mkdir -p $ANDROID_HOME/cmdline-tools
        mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" "platforms;android-33" "build-tools;33.0.0" "ndk;25.2.9519653"
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
        
    - name: Create pyjnius patch script
      run: |
        mkdir -p /tmp/patches
        cat > /tmp/patches/patch_pyjnius.py << 'ENDSCRIPT'
        import os
        import sys
        
        def patch_pyjnius_files():
            base_paths = [
                os.path.expanduser("~/.buildozer/android/platform/build-arm64-v8a/build/other_builds"),
                os.path.expanduser("~/.buildozer/android/platform/build-arm64-v8a_armeabi-v7a/build/other_builds"),
            ]
            
            patched = 0
            for base_path in base_paths:
                if not os.path.exists(base_path):
                    continue
                for root, dirs, files in os.walk(base_path):
                    if "pyjnius" in root.lower():
                        for file in files:
                            if file.endswith((".pxi", ".pyx")):
                                filepath = os.path.join(root, file)
                                try:
                                    with open(filepath, "r") as f:
                                        content = f.read()
                                    if "isinstance(arg, long)" in content:
                                        content = content.replace(
                                            "isinstance(arg, long)",
                                            "isinstance(arg, int)"
                                        )
                                        with open(filepath, "w") as f:
                                            f.write(content)
                                        print(f"Patched: {filepath}")
                                        patched += 1
                                except Exception as e:
                                    print(f"Error patching {filepath}: {e}")
            
            return patched
        
        if __name__ == "__main__":
            count = patch_pyjnius_files()
            print(f"Total files patched: {count}")
        ENDSCRIPT
        chmod +x /tmp/patches/patch_pyjnius.py
        
    - name: Setup python-for-android
      run: |
        rm -rf ~/.buildozer/android/platform/python-for-android
        mkdir -p ~/.buildozer/android/platform
        git clone --depth 1 --branch develop \
          https://github.com/kivy/python-for-android.git \
          ~/.buildozer/android/platform/python-for-android
        echo "P4A ready"
        
    - name: Prepare buildozer.spec
      run: |
        echo "" >> buildozer.spec
        echo "android.sdk_path = /usr/local/lib/android/sdk" >> buildozer.spec
        echo "android.ndk_path = /usr/local/lib/android/sdk/ndk/25.2.9519653" >> buildozer.spec
        
    - name: Build APK
      run: |
        # 链接 SDK
        mkdir -p ~/.buildozer/android/platform
        rm -rf ~/.buildozer/android/platform/android-sdk
        ln -sf /usr/local/lib/android/sdk ~/.buildozer/android/platform/android-sdk
        if [ ! -d /usr/local/lib/android/sdk/tools ]; then
          ln -sf /usr/local/lib/android/sdk/cmdline-tools/latest /usr/local/lib/android/sdk/tools
        fi
        
        # 清理之前的构建
        rm -rf .buildozer/android/platform/build-*/dists/
        
        # 后台运行修补脚本
        (
          for i in $(seq 1 120); do
            sleep 5
            python3 /tmp/patches/patch_pyjnius.py 2>/dev/null || true
          done
        ) &
        PATCH_PID=$!
        
        # 构建
        buildozer android debug || {
          echo "Build failed, attempting patch and retry..."
          python3 /tmp/patches/patch_pyjnius.py 2>/dev/null || true
          buildozer android debug
        }
        
        kill $PATCH_PID 2>/dev/null || true
        
      timeout-minutes: 60
      
    - name: Check APK
      if: always()
      run: |
        ls -la bin/ 2>/dev/null || echo "No bin directory"
        find . -name "*.apk" 2>/dev/null || true
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: .buildozer/android/platform/build-*/build.log
        retention-days: 3
        if-no-files-found: ignore
        
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: retail-survey-apk
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: warn
